<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:FlowModules.ViewModels"
             xmlns:nodify="clr-namespace:NodifyM;assembly=NodifyM.Avalonia"
             xmlns:viewModelBase1="clr-namespace:NodifyM.Avalonia.ViewModelBase;assembly=NodifyM.Avalonia"
             xmlns:converters="clr-namespace:NodifyM.Avalonia.Converters;assembly=NodifyM.Avalonia"
             xmlns:controls="clr-namespace:NodifyM.Avalonia.Controls"
             xmlns:converters1="clr-namespace:NodifyM.Avalonia.Converters"
             xmlns:viewModelBase="clr-namespace:NodifyM.Avalonia.ViewModelBase"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:DataType="vm:FlowViewModel"
             x:Name="EditorView"
             x:Class="FlowModules.Views.FlowView">
    <!-- <controls:KnotNode.ContextMenu> -->
    <!--     <ContextMenu> -->
    <!--         <MenuItem Header="_Delete" -->
    <!--                   Command="{Binding ((vm:FlowViewModel)DataContext).DeleteNodeCommand, -->
    <!--                                           ElementName=EditorView}" -->
    <!--                   CommandParameter="{Binding}" /> -->
    <!--     </ContextMenu> -->
    <!-- </controls:KnotNode.ContextMenu> -->
    <Grid>
        <StackPanel ZIndex="1" HorizontalAlignment="Left">
            <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="{Binding Zoom,StringFormat=Zoom: {0:N2}}"></TextBlock>
                <TextBlock Text="{Binding OffsetX,StringFormat=OffsetX: {0:N2}}"></TextBlock>
                <TextBlock Text="{Binding OffsetY,StringFormat=OffsetY: {0:N2}}"></TextBlock>
            </StackPanel>

            <Button Content="Add Node" Command="{Binding AddNodeCommand}"></Button>
            <Button Content="Zoom To Fit">
                <Button.Command>
                    <!-- 直接调用Editor的ZoomToFitAll方法，不通过ViewModel -->
                    <Binding RelativeSource="{RelativeSource AncestorType=controls:NodifyEditor}"
                           Path="ZoomToFitAll" />
                </Button.Command>
            </Button>
            <Button Content="Reset View" Click="ResetViewClick"></Button>
            <!-- <TextBlock Text="{Binding #Editor.SelectedItem}"></TextBlock> -->
            <Slider Maximum="10" Minimum="0.1" Value="{Binding Zoom,TargetNullValue=1,Mode=TwoWay}" Name="Slider"
                    Width="200">
            </Slider>
            <Button Content="FitAll" Click="FitAllContentClick" ></Button>

        </StackPanel>

        <controls:NodifyEditor x:Name="Editor"
                               Background="Transparent"
                               ItemsSource="{Binding Nodes }"
                               Connections="{Binding Connections}"
                               PendingConnection="{Binding PendingConnection}"
                               Zoom="{Binding Zoom,Mode=TwoWay}"
                               OffsetX="{Binding OffsetX,Mode=TwoWay}"
                               OffsetY="{Binding OffsetY,Mode=TwoWay}"
                               DisconnectConnectorCommand="{Binding DisconnectConnectorCommand}">

            <controls:NodifyEditor.Resources>
                <converters1:FlowToDirectionConverter x:Key="FlowToDirectionConverter" />

            </controls:NodifyEditor.Resources>
            <controls:NodifyEditor.GridLineTemplate>
                <DataTemplate>
                    <controls:LargeGridLine Width="{Binding $parent[controls:NodifyEditor].Bounds.Width}"
                                            OffsetX="{Binding $parent[controls:NodifyEditor].OffsetX}"
                                            OffsetY="{Binding $parent[controls:NodifyEditor].OffsetY}"
                                            Zoom="{Binding $parent[controls:NodifyEditor].Zoom}"
                                            Height="{Binding $parent[controls:NodifyEditor].Bounds.Height}"
                                            Spacing="30"
                                            Thickness="0.5"
                                            Brush="{StaticResource GridLinesColorBrush}"
                                            ZIndex="-2" />
                </DataTemplate>
            </controls:NodifyEditor.GridLineTemplate>
            <controls:NodifyEditor.ConnectionTemplate>
                <DataTemplate DataType="{x:Type viewModelBase:ConnectionViewModelBase}">
                    <Grid>
                        <controls:Connection
                            TextBrush="{StaticResource Connection.TextColorBrush}"
                            Text="{Binding Text}"
                            TextPoint="50%,50%"
                            SplitCommand="{Binding SplitConnectionCommand}"
                            DisconnectCommand="{Binding DisconnectConnectionCommand}"
                            Direction="{Binding .,Converter={StaticResource FlowToDirectionConverter}}"
                            Source="{Binding Source.Anchor}" Focusable="True"
                            Target="{Binding Target.Anchor}">
                            <controls:Connection.Stroke>
                                <SolidColorBrush Color="Red"
                                                 Opacity="0.5" />
                            </controls:Connection.Stroke>
                            <controls:Connection.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="_Delete" />
                                </ContextMenu>
                            </controls:Connection.ContextMenu>
                        </controls:Connection>
                    </Grid>

                </DataTemplate>
            </controls:NodifyEditor.ConnectionTemplate>
            <controls:NodifyEditor.PendingConnectionTemplate>
                <DataTemplate DataType="{x:Type viewModelBase:PendingConnectionViewModelBase}">
                    <controls:PendingConnection
                        StartedCommand="{Binding StartCommand}"
                        CompletedCommand="{Binding FinishCommand}"
                        EnablePreview="True"
                        EnableSnapping="True"
                        Direction="{Binding Source.Flow,Converter={StaticResource FlowToDirectionConverter}}"
                        PreviewTarget="{Binding PreviewTarget, Mode=OneWayToSource}">
                        <controls:PendingConnection.Stroke>
                            <SolidColorBrush Color="Red"
                                             Opacity="0.5" />

                        </controls:PendingConnection.Stroke>
                        <controls:PendingConnection.Background>
                            <SolidColorBrush Color="DodgerBlue"
                                             Opacity="0.8" />
                        </controls:PendingConnection.Background>
                        <TextBlock Text="{Binding PreviewText}" />


                    </controls:PendingConnection>

                </DataTemplate>
            </controls:NodifyEditor.PendingConnectionTemplate>
            <controls:NodifyEditor.ItemTemplate>
                <controls:NodeTemplateSelector>
                    <DataTemplate DataType="controls:NodeGroup">
                        <controls:NodeGroup Header="{Binding Header}"
                                            CanResize="{Binding CanResize}"
                                            Size="{Binding Size}">
                        </controls:NodeGroup>
                    </DataTemplate>
                    <DataTemplate DataType="viewModelBase:KnotNodeViewModel">
                        <controls:KnotNode
                            Location="{Binding Location,Mode=TwoWay}"
                            Content="{Binding Connector}">
                            <controls:KnotNode.ContentTemplate>
                                <DataTemplate DataType="viewModelBase:ConnectorViewModelBase">
                                    <controls:Connector
                                        VerticalAlignment="Center"
                                        IsConnected="{Binding IsConnected}"
                                        Anchor="{Binding Anchor, Mode=OneWayToSource}">
                                        <controls:Connector.BorderBrush>
                                            <SolidColorBrush
                                                Color="CornflowerBlue"
                                                Opacity="0.5" />
                                        </controls:Connector.BorderBrush>
                                    </controls:Connector>
                                </DataTemplate>
                            </controls:KnotNode.ContentTemplate>
                        </controls:KnotNode>
                    </DataTemplate>
                    <DataTemplate DataType="viewModelBase:NodeViewModelBase">
                        <controls:Node x:Name="Node"
                                       Input="{Binding Input}"
                                       Header="{Binding Title}"
                                       Location="{Binding Location,Mode=TwoWay}"
                                       VerticalAlignment="Center"
                                       Output="{Binding Output}">
                            <controls:Node.Styles>
                                <Style Selector="controls|Node[IsSelected=False]:pointerover">
                                    <Setter Property="BorderBrush" Value="AliceBlue"></Setter>
                                </Style>
                            </controls:Node.Styles>
                            <controls:Node.InputConnectorTemplate>
                                <DataTemplate DataType="{x:Type viewModelBase:ConnectorViewModelBase}">
                                    <controls:NodeInput
                                        x:Name="NodeInput"
                                        VerticalAlignment="Center"
                                        IsConnected="{Binding IsConnected}"
                                        Anchor="{Binding Anchor, Mode=OneWayToSource}">
                                        <controls:NodeInput.Header>
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                                        HorizontalAlignment="Right">

                                                <TextBlock VerticalAlignment="Center" x:Name="textBlock"
                                                           Text="{Binding Title}" />
                                            </StackPanel>
                                        </controls:NodeInput.Header>
                                        <controls:NodeInput.BorderBrush>
                                            <SolidColorBrush
                                                Color="CornflowerBlue"
                                                Opacity="0.5" />
                                        </controls:NodeInput.BorderBrush>
                                    </controls:NodeInput>
                                </DataTemplate>
                            </controls:Node.InputConnectorTemplate>

                            <controls:Node.OutputConnectorTemplate>
                                <DataTemplate DataType="{x:Type viewModelBase:ConnectorViewModelBase}">
                                    <controls:NodeOutput
                                        x:Name="NodeOutput"
                                        VerticalAlignment="Center"
                                        IsConnected="{Binding IsConnected}"
                                        Anchor="{Binding Anchor, Mode=OneWayToSource}">
                                        <controls:NodeOutput.Header>
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                                        HorizontalAlignment="Right">

                                                <TextBlock VerticalAlignment="Center" x:Name="textBlock"
                                                           Text="{Binding Title}" />
                                            </StackPanel>
                                        </controls:NodeOutput.Header>
                                        <controls:NodeOutput.BorderBrush>
                                            <SolidColorBrush
                                                Color="CornflowerBlue"
                                                Opacity="0.5" />
                                        </controls:NodeOutput.BorderBrush>
                                    </controls:NodeOutput>
                                </DataTemplate>
                            </controls:Node.OutputConnectorTemplate>
                        </controls:Node>
                    </DataTemplate>
                </controls:NodeTemplateSelector>
            </controls:NodifyEditor.ItemTemplate>


        </controls:NodifyEditor>
    </Grid>
</UserControl>